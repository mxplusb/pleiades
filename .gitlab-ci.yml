variables:
  GO_VERSION: "1.19"
  MAGE_VERSION: "1.13.0"

stages:
  - build

cache:
  paths:
    - /apt-cache
    - /go/src/github.com
    - /go/src/golang.org
    - /go/src/google.golang.org
    - /go/src/gopkg.in

before_script:
  - ci/scripts/install-mage.sh

build:
  stage: build
  image: "golang:$GO_VERSION"
  script:
    - |
      mage install:godeps
      mage build:compile
  artifacts:
    reports:
      dotenv: gl-auto-build-variables.env
  rules:
    - if: '$BUILD_DISABLED'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'

test:
  stage: test
  image: "golang:$GO_VERSION"
  script:
    - go test ./... -coverprofile=coverage.txt -covermode count
    - go get github.com/boumenot/gocover-cobertura
    - go run github.com/boumenot/gocover-cobertura < coverage.txt > coverage.xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
